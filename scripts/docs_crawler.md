# docs_crawler ガイド

最終更新: 2025-10-19  
適用範囲: `scripts/docs_crawler.py`

---

## 1. ツール概要

`docs_crawler.py` は、リポジトリ内のドキュメントと公開 API を走査し次の成果物を生成する CLI です。

出力（既定の出力先: `./.shiori/`）:

| ファイル | 内容 |
|----------|------|
| `docs-inventory.csv` | ドキュメント一覧（パス、サイズ、見出し、リンク等） |
| `api-surface.csv` | 公開 API サーフェス（言語 / 種別 / 名前 / ファイルパス） |
| `coverage.csv` | シンボルがどの文書で言及されているか |
| `drift_report.md` | 乖離レポート（未ドキュメント、追加 / 削除シンボル等） |
| `snapshot.json` / `snapshots/` | スナップショット比較用のメタデータ |

### 実行例

```bash
# 既定（Python, TS/JS, Go, Rust, Java/Kotlin を対象）
python scripts/docs_crawler.py --repo .

# 表示されるメッセージ:
# ✅ 完了
#   Repo: /path/to/repo
#   Docs: XXX files
#   Symbols: YYY unique
#   Out: /path/to/repo/.shiori
#   Report: /path/to/repo/.shiori/drift_report.md

# 言語・ディレクトリを絞り込む
python scripts/docs_crawler.py \
  --repo . \
  --langs py,ts,go \
  --ignore node_modules,dist,.git

# 前回スナップショットとの比較なし（最新状態だけ知りたい）
python scripts/docs_crawler.py --repo . --since-snapshot none
```

> `--out` で出力先を変えた場合も、そのディレクトリ名は自動的に探索対象から除外されます。

---

## 2. 現状の機能

- Markdown / reStructuredText / AsciiDoc / テキストの見出し・リンク抽出
- Python / TS/JS / Go / Rust / Java / Kotlin の軽量 API 抽出
- シンボルとドキュメント言及の突き合わせ
- スナップショット比較（追加 / 削除 / 未ドキュメントの報告）
- 自動的に `.shiori/` を除外、再スキャンによるノイズを防止

---

## 3. 最近の改善点（2025-10-19）

- `os.walk()` + pruning による高速なディレクトリ走査（`node_modules` 等を探索しない）
- ドキュメント本文をキャッシュし、シンボル照合時の再読込を解消
- `discover_docs()` 内で見出し・リンクを一度だけ抽出し、ダブり計算を削減
- 出力・スナップショットでは本文を含めず、運用アーティファクトをクリーンに維持
- CLI ドキュメントを `scripts/` 配置に合わせて修正（以前は `tools/` 表記）

---

## 4. 今後の拡張アイデア（コンテキストエンジニアリング向け）

1. **フレッシュネス指標**  
   - シンボルの最終コミット日時とドキュメント更新日時を突き合わせ、乖離が大きい箇所に「更新要検討」フラグを付与。  
   - 要件 ID / タスク番号を含む文書は `git log -- path` で参照有無をチェックし、未参照なら警告する。

2. **仕様リンク整合性チェック**  
   - ADR や requirements へのリンク切れ検出（404, 相対パスのズレなど）。  
   - 文書内の `REQ-xxx` / `TASK-x.x` と実体（spec / tasks ファイル）を突き合わせる。

3. **TODO / FIXME 棚卸し**  
   - 「TODO」「未対応」「検討中」などのキーワードを抽出し、完了済みならクローズ、未完了なら優先度判定の材料にする。

4. **冗長パートの可視化（コンパクト化ガイダンス）**  
   - 長大セクションを自動要約して「要約候補」を drift_report に追記。  
   - パラグラフの類似度を測り、重複しているドキュメントのセットを提示。

5. **ドキュメント参照グラフ**  
   - 文書間・コードファイルとのリンクをグラフ化し、孤立している文書／参照が集中している文書を可視化。  
   - 孤立文書は統合候補、中核文書は優先的に最新化する対象としてリストアップする。

6. **コード→ドキュメント逆引き**  
   - Rust の doc comment や Python の docstring, TypeScript の `/** ... */` から公開 API を抽出し、ドキュメント未掲載の説明を検知。

7. **カテゴリ別棚卸し**  
   - `docs/dev`, `docs/uml`, `.kiro/specs/...` などカテゴリごとの件数・最終更新日分布を出し、「不足している領域」「冗長な領域」を把握。

8. **散逸メモの検知**  
   - `YYYY-MM-DD` を含む Markdown や雑記を一覧化し、一定期間更新がないものをアーカイブ候補として提示。

9. **統合サマリーレポート**  
   - ドキュメント総数 / API シンボル数 / 未ドキュメント数 / 更新が古いトップ10 / TODO 件数 / リンク切れ数などを 1 枚の Markdown にまとめ、週次レビュー用のダッシュボードとして活用。  
   - 可能であれば drift_report.md にサマリーセクションを追加し、自動生成。

10. **PR 差分フック**  
    - Pull Request の差分だけに対して docs_crawler を走らせ、「新規公開APIが文書化されていない」等のコメントを自動投稿。

各アイデアは段階的に導入できるよう、小さいレポート追加や既存 CSV へのフィールド追加から着手する想定です。優先度としては、1（フレッシュネス）、3（TODO棚卸し）、5（参照グラフ）あたりが効果を実感しやすく、コンパクト化のスキーム（4,9）と組み合わせると「整然としたドキュメント体系」を維持しやすくなります。

これらは段階的に導入できるよう、`drift_report.md` へ追加セクションを差し込む・CSV にフィールドを増やす等、小さなステップで進めることを想定しています。

---

## 5. 開発メモ

- コードは Python 3.9+ で動作確認しています。標準ライブラリ以外の依存はありません。
- 大きなリポジトリで時間がかかる場合は `--langs` と `--ignore` を組み合わせて部分的にスキャンしてください。
- 既存レポートを利用する際は `snapshot.json` を VCS に含めるかどうかチームで合意すること（Git 管理すると差分追跡が容易）。
- 追加アイデアを実装する際は、このファイルに追記し、ユースケース・目的を明記してください。
